<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>智能地图系统</title>
    <!-- 引入Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- 引入Leaflet.markercluster用于点聚合 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <!-- 引入html2canvas用于截图 -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <!-- 引入Font Awesome图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* 基础样式重置与全局配置 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        
        body {
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #0f172a;
            color: #e2e8f0;
            overflow: hidden;
        }
        
        /* 加载动画 */
        .loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        
        .loader.hidden {
            opacity: 0;
            visibility: hidden;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(96, 165, 250, 0.2);
            border-top: 5px solid #60a5fa;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loader-text {
            font-size: 18px;
            color: #bfdbfe;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* 提示消息组件 */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toast {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 12px 18px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            border-left: 4px solid;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 280px;
            max-width: 400px;
            animation: slideIn 0.3s ease forwards, fadeOut 0.3s ease 2.7s forwards;
        }
        
        .toast.success {
            border-left-color: #4ade80;
        }
        
        .toast.error {
            border-left-color: #f87171;
        }
        
        .toast.info {
            border-left-color: #38bdf8;
        }
        
        .toast.warning {
            border-left-color: #fbbf24;
        }
        
        .toast-icon {
            font-size: 18px;
        }
        
        .toast.success .toast-icon {
            color: #4ade80;
        }
        
        .toast.error .toast-icon {
            color: #f87171;
        }
        
        .toast.info .toast-icon {
            color: #38bdf8;
        }
        
        .toast.warning .toast-icon {
            color: #fbbf24;
        }
        
        .toast-text {
            font-size: 14px;
            line-height: 1.4;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        /* 地图容器样式 */
        #map {
            flex: 1;
            width: 100%;
            z-index: 1;
            transition: all 0.3s ease;
        }
        
        /* 控制面板容器 - 左右分栏布局 */
        .controls-container {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 400;
            display: flex;
            gap: 16px;
        }
        
        /* 面板折叠按钮 */
        .panel-toggle {
            position: absolute;
            left: -24px;
            top: 10px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #60a5fa;
            transition: all 0.2s ease;
            z-index: 10;
        }
        
        .panel-toggle:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: scale(1.1);
        }
        
        /* 左侧控制面板 - 基础控制功能 */
        .control-panel-left,
        .control-panel-right {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 18px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 280px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .control-panel.collapsed {
            width: 60px;
            padding: 18px 10px;
        }
        
        .control-panel.collapsed .panel-content {
            display: none;
        }
        
        .control-panel.collapsed .panel-icon {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .control-panel.collapsed .panel-icon i {
            font-size: 24px;
            color: #60a5fa;
        }
        
        .control-panel-left:hover,
        .control-panel-right:hover {
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
            transform: translateY(-2px);
        }
        
        /* 控制按钮样式 */
        .control-btn {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 8px;
            padding: 10px 14px;
            margin: 6px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.25s ease;
            width: 100%;
            justify-content: flex-start;
            color: #e2e8f0;
            font-size: 14px;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .control-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(96, 165, 250, 0.1), transparent);
            transition: left 0.6s ease;
        }
        
        .control-btn:hover::after {
            left: 100%;
        }
        
        .control-btn i {
            width: 18px;
            text-align: center;
            color: #60a5fa;
        }
        
        .control-btn:hover {
            background-color: rgba(59, 130, 246, 0.2);
            border-color: rgba(96, 165, 250, 0.6);
            transform: translateX(3px);
        }
        
        .control-btn.active {
            background-color: rgba(59, 130, 246, 0.3);
            border-color: #60a5fa;
            color: #bfdbfe;
            box-shadow: 0 0 10px rgba(96, 165, 250, 0.3);
        }
        
        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            background-color: rgba(30, 41, 59, 0.5);
            border-color: rgba(96, 165, 250, 0.2);
        }
        
        /* 控制区域分隔 */
        .control-section {
            margin-bottom: 18px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .control-section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .control-section h4 {
            margin: 0 0 10px 0;
            color: #bfdbfe;
            font-size: 15px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .control-section h4 i {
            color: #38bdf8;
            font-size: 16px;
        }
        
        /* 信息面板样式 */
        .info-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 400;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 18px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 320px;
            transition: all 0.3s ease;
        }
        
        .info-panel:hover {
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }
        
        .info-panel h3 {
            margin-top: 0;
            margin-bottom: 12px;
            color: #38bdf8;
            font-size: 18px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-panel p {
            margin: 8px 0;
            color: #e2e8f0;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .info-panel p strong {
            color: #bfdbfe;
            font-weight: 500;
        }
        
        /* 测量信息样式 */
        .measure-info {
            background: rgba(15, 23, 42, 0.9);
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #e2e8f0;
            font-size: 14px;
        }
        
        /* 选择器样式 */
        .layer-selector {
            margin: 8px 0;
            padding: 10px 12px;
            width: 100%;
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 14px;
            transition: all 0.25s ease;
        }
        
        .layer-selector:focus {
            outline: none;
            border-color: #60a5fa;
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2);
        }
        
        .layer-selector option {
            background: #1e293b;
            color: #e2e8f0;
        }
        
        /* 定位状态样式 */
        .location-status {
            color: #fca5a5;
            font-size: 13px;
            margin-top: 8px;
            padding: 6px 8px;
            border-radius: 6px;
            background: rgba(15, 23, 42, 0.5);
            transition: all 0.2s ease;
        }
        
        /* 脉冲动画优化 */
        .pulse-animation {
            animation: pulse 1.5s infinite ease-in-out;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(252, 165, 165, 0.6);
            }
            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 12px rgba(252, 165, 165, 0);
            }
            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(252, 165, 165, 0);
            }
        }
        
        /* POI搜索样式优化 */
        .search-container {
            position: absolute;
            top: 20px;
            left: 500px;
            transform: translateX(-50%);
            z-index: 400;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 380px;
            max-width: calc(100% - 40px);
            transition: all 0.3s ease;
        }
        
        .search-container:hover {
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }
        
        .search-box {
            display: flex;
            gap: 8px;
        }
        
        .search-input {
            flex: 1;
            padding: 11px 14px;
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 8px;
            font-size: 14px;
            color: #e2e8f0;
            transition: all 0.25s ease;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #60a5fa;
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2);
            background: rgba(30, 41, 59, 0.9);
        }
        
        .search-input::placeholder {
            color: #94a3b8;
            opacity: 1;
        }
        
        .search-btn {
            padding: 11px 16px;
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.25s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .search-btn:hover {
            background-color: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .search-btn:active {
            transform: translateY(0);
        }
        
        .search-results {
            margin-top: 12px;
            max-height: 240px;
            overflow-y: auto;
            border-radius: 8px;
            background: rgba(30, 41, 59, 0.5);
        }
        
        /* 滚动条美化 */
        .search-results::-webkit-scrollbar {
            width: 6px;
        }
        
        .search-results::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.3);
            border-radius: 3px;
        }
        
        .search-results::-webkit-scrollbar-thumb {
            background: rgba(96, 165, 250, 0.4);
            border-radius: 3px;
        }
        
        .search-results::-webkit-scrollbar-thumb:hover {
            background: rgba(96, 165, 250, 0.6);
        }
        
        .search-result-item {
            padding: 12px 14px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .search-result-item:hover {
            background-color: rgba(59, 130, 246, 0.2);
            padding-left: 16px;
        }
        
        .search-result-title {
            font-weight: 500;
            margin-bottom: 4px;
            color: #bfdbfe;
            font-size: 15px;
        }
        
        .search-result-address {
            font-size: 13px;
            color: #94a3b8;
            line-height: 1.4;
        }
        
        .search-result-category {
            font-size: 12px;
            color: #64748b;
            margin-top: 3px;
        }
        
        .search-status {
            padding: 14px 12px;
            color: #94a3b8;
            text-align: center;
            font-size: 14px;
        }
        
        /* 透明度控制样式优化 */
        .opacity-control {
            width: 100%;
            margin: 12px 0 6px 0;
            height: 6px;
            border-radius: 3px;
            background: rgba(30, 41, 59, 0.7);
            outline: none;
            transition: all 0.2s ease;
        }
        
        .opacity-control::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #60a5fa;
            cursor: pointer;
            box-shadow: 0 0 8px rgba(96, 165, 250, 0.5);
            transition: all 0.2s ease;
        }
        
        .opacity-control::-webkit-slider-thumb:hover {
            background: #3b82f6;
            transform: scale(1.1);
        }
        
        .opacity-label {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            margin-bottom: 6px;
            color: #94a3b8;
        }
        
        /* 路线规划面板 */
        .route-panel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 400;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 18px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 320px;
            max-width: calc(100% - 40px);
            transition: all 0.3s ease, transform 0.3s ease;
            transform: translateY(120%);
            opacity: 0;
            pointer-events: none;
        }
        
        .route-panel.active {
            transform: translateY(0);
            opacity: 1;
            pointer-events: all;
        }
        
        .route-panel:hover {
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }
        
        .route-panel h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #38bdf8;
            font-size: 18px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .route-input-group {
            position: relative;
            margin-bottom: 12px;
        }
        
        .route-input {
            width: 100%;
            padding: 11px 14px 11px 36px;
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 8px;
            font-size: 14px;
            color: #e2e8f0;
            transition: all 0.25s ease;
        }
        
        .route-input:focus {
            outline: none;
            border-color: #60a5fa;
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2);
            background: rgba(30, 41, 59, 0.9);
        }
        
        .route-input-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #60a5fa;
        }
        
        .route-mode-selector {
            display: flex;
            gap: 8px;
            margin: 15px 0;
        }
        
        .route-mode-btn {
            flex: 1;
            padding: 8px 0;
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .route-mode-btn.active {
            background-color: rgba(59, 130, 246, 0.3);
            border-color: #60a5fa;
            color: #bfdbfe;
        }
        
        .route-mode-btn:hover:not(.active) {
            background-color: rgba(59, 130, 246, 0.1);
        }
        
        .route-results {
            margin-top: 15px;
            max-height: 160px;
            overflow-y: auto;
        }
        
        .route-result-item {
            padding: 10px 12px;
            border-radius: 6px;
            background: rgba(30, 41, 59, 0.5);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .route-result-item:hover {
            background: rgba(30, 41, 59, 0.7);
        }
        
        .route-result-title {
            font-size: 14px;
            font-weight: 500;
            color: #bfdbfe;
            margin-bottom: 4px;
        }
        
        .route-result-details {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #94a3b8;
        }
        
        /* 路线详情面板 */
        .route-details-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 400;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 18px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 320px;
            max-height: calc(100% - 40px);
            overflow-y: auto;
            transform: translateX(-120%);
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
        }
        
        .route-details-panel.active {
            transform: translateX(0);
            opacity: 1;
            pointer-events: all;
        }
        
        .route-details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .route-details-title {
            color: #38bdf8;
            font-size: 18px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .close-route-details {
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s ease;
        }
        
        .close-route-details:hover {
            color: #f87171;
        }
        
        .route-summary {
            background: rgba(30, 41, 59, 0.5);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .route-summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .route-summary-item:last-child {
            margin-bottom: 0;
        }
        
        .route-summary-label {
            color: #94a3b8;
        }
        
        .route-summary-value {
            color: #e2e8f0;
            font-weight: 500;
        }
        
        .route-steps {
            margin-top: 15px;
        }
        
        .route-step {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .route-step:last-child {
            border-bottom: none;
        }
        
        .step-number {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(59, 130, 246, 0.3);
            color: #60a5fa;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 500;
            flex-shrink: 0;
        }
        
        .step-details {
            flex: 1;
        }
        
        .step-instruction {
            font-size: 14px;
            color: #e2e8f0;
            margin-bottom: 4px;
        }
        
        .step-distance {
            font-size: 12px;
            color: #94a3b8;
        }
        
        /* 公交站台标记样式 */
        .bus-stop-marker {
            background-color: #f59e0b;
            border-radius: 50%;
            border: 2px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        /* 响应式调整 */
        @media (max-width: 1024px) {
            .controls-container {
                flex-direction: column;
                top: 20px;
                right: 20px;
            }
            
            .control-panel-left,
            .control-panel-right {
                width: 260px;
            }
            
            .route-panel,
            .route-details-panel {
                width: calc(100% - 40px);
            }
        }
        
        @media (max-width: 768px) {
            .search-container {
                width: calc(100% - 40px);
                left: 20px;
                transform: none;
            }
            
            .info-panel {
                max-width: calc(100% - 40px);
            }
            
            .controls-container {
                top: auto;
                bottom: 20px;
                right: 20px;
                z-index: 399;
            }
            
            .route-details-panel {
                width: calc(100% - 40px);
                max-height: 70%;
            }
        }
    </style>
</head>
<body>
    <!-- 加载动画 -->
    <div class="loader" id="loader">
        <div class="spinner"></div>
        <div class="loader-text"><i class="fas fa-map-signs"></i> 正在加载智能地图系统...</div>
    </div>
    
    <!-- 提示消息容器 -->
    <div class="toast-container" id="toastContainer"></div>
    
    <div id="map"></div>
    
    <!-- POI搜索容器 -->
    <div class="search-container">
        <div class="search-box">
            <input type="text" class="search-input" id="poiSearchInput" placeholder="搜索兴趣点（如：餐厅、银行、景点）">
            <button class="search-btn" id="poiSearchBtn">
                <i class="fas fa-search"></i> 搜索
            </button>
        </div>
        <div class="search-results" id="searchResults">
            <div class="search-status">请输入关键词进行搜索</div>
        </div>
    </div>
    
    <!-- 控制面板容器 - 分为左右两栏 -->
    <div class="controls-container">
        <!-- 左侧控制面板 - 基础控制功能 -->
        <div class="control-panel-left control-panel">
            <div class="panel-toggle" id="leftPanelToggle">
                <i class="fas fa-chevron-left"></i>
            </div>
            <div class="panel-icon">
                <i class="fas fa-sliders-h"></i>
            </div>
            <div class="panel-content">
                <div class="control-section">
                    <h4><i class="fas fa-compress-arrows-alt"></i> 基础控制</h4>
                    <button class="control-btn" id="zoomIn" title="放大地图">
                        <i class="fas fa-search-plus"></i> 放大
                    </button>
                    <button class="control-btn" id="zoomOut" title="缩小地图">
                        <i class="fas fa-search-minus"></i> 缩小
                    </button>
                    <button class="control-btn" id="centerMap" title="重置地图中心">
                        <i class="fas fa-compress-arrows-alt"></i> 重置中心
                    </button>
                </div>
                
                <div class="control-section">
                    <h4><i class="fas fa-location-arrow"></i> 定位功能</h4>
                    <button class="control-btn" id="locateMe" title="获取当前位置">
                        <i class="fas fa-location-arrow"></i> 定位我的位置
                    </button>
                    <button class="control-btn" id="followLocation" disabled title="跟随位置移动">
                        <i class="fas fa-compass"></i> 跟随位置
                    </button>
                    <div id="locationStatus" class="location-status"></div>
                </div>
                
                <div class="control-section">
                    <h4><i class="fas fa-map"></i> 图层控制</h4>
                    <select class="layer-selector" id="layerSelector" title="选择地图图层">
                        <option value="vector">高德矢量地图</option>
                        <option value="satellite">高德卫星地图</option>
                        <option value="terrain">高德地形地图</option>
                    </select>
                    <div class="opacity-label">
                        <span>图层透明度</span>
                        <span id="opacityValue">100%</span>
                    </div>
                    <input type="range" min="10" max="100" value="100" class="opacity-control" id="opacityControl" title="调整图层透明度">
                </div>
            </div>
        </div>
        
        <!-- 右侧控制面板 - 高级功能 -->
        <div class="control-panel-right control-panel">
            <div class="panel-toggle" id="rightPanelToggle">
                <i class="fas fa-chevron-left"></i>
            </div>
            <div class="panel-icon">
                <i class="fas fa-cogs"></i>
            </div>
            <div class="panel-content">
                <div class="control-section">
                    <h4><i class="fas fa-route"></i> 轨迹与标记</h4>
                    <button class="control-btn" id="addMarker" title="在当前位置添加标记">
                        <i class="fas fa-map-marker-alt"></i> 添加标记
                    </button>
                    <button class="control-btn" id="showCluster" title="显示点聚合效果">
                        <i class="fas fa-th"></i> 显示点聚合
                    </button>
                    <button class="control-btn" id="showTrack" title="显示动态轨迹">
                        <i class="fas fa-route"></i> 显示动态轨迹
                    </button>
                    <button class="control-btn" id="clearMarkers" title="清除所有标记和轨迹">
                        <i class="fas fa-trash"></i> 清除所有标记
                    </button>
                </div>
                
                <div class="control-section">
                    <h4><i class="fas fa-ruler"></i> 测量与截图</h4>
                    <button class="control-btn" id="startMeasure" title="测量距离">
                        <i class="fas fa-ruler"></i> 开始测量
                    </button>
                    <button class="control-btn" id="stopMeasure" disabled title="停止测量">
                        <i class="fas fa-stop"></i> 停止测量
                    </button>
                    <button class="control-btn" id="takeScreenshot" title="保存地图截图">
                        <i class="fas fa-camera"></i> 地图截图
                    </button>
                </div>
                
                <div class="control-section">
                    <h4><i class="fas fa-directions"></i> 路线规划</h4>
                    <button class="control-btn" id="showRoutePanel" title="规划路线">
                        <i class="fas fa-road"></i> 路线规划
                    </button>
                    <button class="control-btn" id="clearRoute" disabled title="清除路线">
                        <i class="fas fa-eraser"></i> 清除路线
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="info-panel">
        <h3><i class="fas fa-info-circle"></i> 地图信息</h3>
        <p><strong>当前中心:</strong> <span id="centerCoord">加载中...</span></p>
        <p><strong>当前缩放级别:</strong> <span id="zoomLevel">加载中...</span></p>
        <p><strong>当前图层:</strong> <span id="currentLayer">高德矢量地图</span></p>
        <p id="userLocation" style="display: none;"><strong>我的位置:</strong> <span id="locationCoord">-</span></p>
        <p id="measureResult" style="display: none;"><strong>测量结果:</strong> <span id="distance">0</span> 米</p>
    </div>
    
    <!-- 路线规划面板 -->
    <div class="route-panel" id="routePanel">
        <h3><i class="fas fa-directions"></i> 路线规划</h3>
        <div class="route-input-group">
            <i class="fas fa-map-marker-alt route-input-icon"></i>
            <input type="text" class="route-input" id="startPoint" placeholder="起点 (默认: 我的位置)" />
        </div>
        <div class="route-input-group">
            <i class="fas fa-flag route-input-icon"></i>
            <input type="text" class="route-input" id="endPoint" placeholder="终点" />
        </div>
        <div class="route-mode-selector">
            <button class="route-mode-btn active" data-mode="driving" title="驾车路线">
                <i class="fas fa-car"></i> 驾车
            </button>
            <button class="route-mode-btn" data-mode="walking" title="步行路线">
                <i class="fas fa-walking"></i> 步行
            </button>
            <button class="route-mode-btn" data-mode="transit" title="公交路线">
                <i class="fas fa-bus"></i> 公交
            </button>
        </div>
        <button class="control-btn" id="calculateRoute" title="计算路线">
            <i class="fas fa-calculator"></i> 计算路线
        </button>
        <div class="route-results" id="routeResults">
            <!-- 路线结果将在这里显示 -->
        </div>
    </div>
    
    <!-- 路线详情面板 -->
    <div class="route-details-panel" id="routeDetailsPanel">
        <div class="route-details-header">
            <div class="route-details-title"><i class="fas fa-directions"></i> 路线详情</div>
            <button class="close-route-details" id="closeRouteDetails"><i class="fas fa-times"></i></button>
        </div>
        <div class="route-summary" id="routeSummary">
            <!-- 路线摘要信息 -->
        </div>
        <div class="route-steps" id="routeSteps">
            <!-- 路线步骤将在这里显示 -->
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    
    <script>
        // 初始化地图，中心点设为北京市
        const map = L.map('map').setView([39.9042, 116.4074], 13);
        
        // 高德地图API密钥
        const AMAP_API_KEY = 'b11dfef2d8f5a9271d97acb083a23aa4';
        
        // 定义各种地图图层，集成API密钥
        const layers = {
            vector: L.tileLayer(`https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}&key=${AMAP_API_KEY}`, {
                subdomains: ['1', '2', '3', '4'],
                attribution: '© 高德地图',
                opacity: 1.0
            }).addTo(map),
            satellite: L.tileLayer(`https://webst0{s}.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}&key=${AMAP_API_KEY}`, {
                subdomains: ['1', '2', '3', '4'],
                attribution: '© 高德地图',
                opacity: 1.0
            }),
            terrain: L.tileLayer(`https://webst0{s}.is.autonavi.com/appmaptile?style=7&x={x}&y={y}&z={z}&key=${AMAP_API_KEY}`, {
                subdomains: ['1', '2', '3', '4'],
                attribution: '© 高德地图',
                opacity: 1.0
            })
        };
        
        // 当前激活的图层
        let currentLayer = layers.vector;
        
        // 添加比例尺控件
        L.control.scale({
            imperial: false,  // 不显示英制单位
            maxWidth: 200     // 比例尺最大宽度
        }).addTo(map);
        
        // 存储地图上的元素
        let markers = [];
        let trackLayer = null;
        let measureLine = null;
        let measurePoints = [];
        let isMeasuring = false;
        let clusterGroup = null;
        let poiMarkers = [];  // 存储POI搜索结果标记
        let routeLayer = null;  // 路线图层
        let routeMarkers = [];  // 路线标记
        let busStopMarkers = []; // 公交站点标记
        let currentRouteData = null; // 当前路线数据
        let currentRouteMode = null; // 当前路线模式
        
        // 定位相关变量
        let userMarker = null;
        let watchId = null;
        let isFollowing = false;
        let lastKnownPosition = null;
        
        // 初始化完成后隐藏加载动画
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('loader').classList.add('hidden');
                showToast('地图加载完成', 'success');
            }, 800);
        });
        
        // 显示提示消息
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = 'info-circle';
            switch (type) {
                case 'success':
                    icon = 'check-circle';
                    break;
                case 'error':
                    icon = 'exclamation-circle';
                    break;
                case 'warning':
                    icon = 'exclamation-triangle';
                    break;
            }
            
            toast.innerHTML = `
                <div class="toast-icon"><i class="fas fa-${icon}"></i></div>
                <div class="toast-text">${message}</div>
            `;
            
            toastContainer.appendChild(toast);
            
            // 3秒后自动移除
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }
        
        // 更新地图信息面板
        function updateMapInfo() {
            const center = map.getCenter();
            const zoom = map.getZoom();
            document.getElementById('centerCoord').textContent = 
                `${center.lat.toFixed(6)}, ${center.lng.toFixed(6)}`;
            document.getElementById('zoomLevel').textContent = zoom;
        }
        
        // 初始化时更新信息
        updateMapInfo();
        
        // 地图移动或缩放时更新信息
        map.on('moveend zoomend', updateMapInfo);
        
        // 1. 图层切换和透明度调整功能
        document.getElementById('layerSelector').addEventListener('change', (e) => {
            const layerType = e.target.value;
            
            // 移除当前图层
            if (currentLayer && map.hasLayer(currentLayer)) {
                map.removeLayer(currentLayer);
            }
            
            // 添加新图层并保持相同的透明度
            currentLayer = layers[layerType];
            map.addLayer(currentLayer);
            
            // 更新透明度滑块位置
            const opacity = Math.round(currentLayer.options.opacity * 100);
            document.getElementById('opacityControl').value = opacity;
            document.getElementById('opacityValue').textContent = `${opacity}%`;
            
            // 更新信息面板
            const layerNames = {
                vector: "高德矢量地图",
                satellite: "高德卫星地图",
                terrain: "高德地形地图"
            };
            document.getElementById('currentLayer').textContent = layerNames[layerType];
            showToast(`已切换至${layerNames[layerType]}`, 'info');
        });
        
        // 图层透明度调整
        document.getElementById('opacityControl').addEventListener('input', (e) => {
            const opacity = parseInt(e.target.value) / 100;
            currentLayer.setOpacity(opacity);
            document.getElementById('opacityValue').textContent = `${e.target.value}%`;
        });
        
        // 2. 动态轨迹展示功能
        function generateRandomTrack(startLat, startLng, pointsCount = 50) {
            const track = [];
            let lat = startLat;
            let lng = startLng;
            
            for (let i = 0; i < pointsCount; i++) {
                // 随机微小移动
                lat += (Math.random() - 0.5) * 0.02;
                lng += (Math.random() - 0.5) * 0.02;
                track.push([lat, lng]);
            }
            
            return track;
        }
        
        document.getElementById('showTrack').addEventListener('click', () => {
            // 清除已有的轨迹
            if (trackLayer) {
                map.removeLayer(trackLayer);
            }
            
            // 如果有用户位置，从用户位置生成轨迹，否则从地图中心生成
            let center;
            if (lastKnownPosition) {
                center = {
                    lat: lastKnownPosition.coords.latitude,
                    lng: lastKnownPosition.coords.longitude
                };
            } else {
                center = map.getCenter();
            }
            
            const trackPoints = generateRandomTrack(center.lat, center.lng);
            
            // 创建轨迹线
            trackLayer = L.polyline(trackPoints, {
                color: '#38bdf8',
                weight: 3,
                opacity: 0.7,
                dashArray: '10, 10'
            }).addTo(map);
            
            // 创建动画标记
            const movingMarker = L.marker(trackPoints[0], {
                icon: L.divIcon({
                    className: 'moving-marker',
                    html: `<div style="background: #38bdf8; width: 12px; height: 12px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.8);"></div>`,
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                })
            }).addTo(map);
            
            // 轨迹动画
            let pointIndex = 0;
            const animateMarker = () => {
                if (pointIndex < trackPoints.length - 1) {
                    pointIndex++;
                    movingMarker.setLatLng(trackPoints[pointIndex]);
                    setTimeout(animateMarker, 100);
                } else {
                    // 动画结束后回到起点重新开始
                    pointIndex = 0;
                    setTimeout(animateMarker, 1000);
                }
            };
            
            // 开始动画
            animateMarker();
            
            // 调整地图视野以显示整个轨迹
            map.fitBounds(trackLayer.getBounds(), { padding: [50, 50] });
            showToast('动态轨迹已生成', 'info');
        });
        
        // 3. 距离测量功能
        document.getElementById('startMeasure').addEventListener('click', () => {
            isMeasuring = true;
            document.getElementById('startMeasure').disabled = true;
            document.getElementById('stopMeasure').disabled = false;
            document.getElementById('measureResult').style.display = 'block';
            
            // 清除之前的测量
            if (measureLine) {
                map.removeLayer(measureLine);
                measureLine = null;
            }
            measurePoints.forEach(point => {
                map.removeLayer(point);
            });
            measurePoints = [];
            
            showToast('点击地图添加测量点，完成后点击停止测量', 'info');
            
            // 添加地图点击事件
            map.on('click', addMeasurePoint);
        });
        
        document.getElementById('stopMeasure').addEventListener('click', () => {
            isMeasuring = false;
            document.getElementById('startMeasure').disabled = false;
            document.getElementById('stopMeasure').disabled = true;
            
            // 移除地图点击事件
            map.off('click', addMeasurePoint);
            
            if (measurePoints.length >= 2) {
                showToast(`测量完成，总距离: ${document.getElementById('distance').textContent} 米`, 'success');
            } else {
                showToast('已停止测量', 'info');
            }
        });
        
        function addMeasurePoint(e) {
            // 添加测量点
            const pointMarker = L.marker(e.latlng, {
                icon: L.divIcon({
                    className: 'measure-point',
                    html: `<div style="background: #38bdf8; width: 8px; height: 8px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.8);"></div>`,
                    iconSize: [12, 12],
                    iconAnchor: [6, 6]
                })
            }).addTo(map);
            
            measurePoints.push(pointMarker);
            
            // 更新测量线
            if (measurePoints.length >= 2) {
                if (measureLine) {
                    map.removeLayer(measureLine);
                }
                
                // 创建测量线
                const linePoints = measurePoints.map(marker => marker.getLatLng());
                measureLine = L.polyline(linePoints, {
                    color: '#38bdf8',
                    weight: 2,
                    dashArray: '5, 5'
                }).addTo(map);
                
                // 计算总距离
                let totalDistance = 0;
                for (let i = 0; i < linePoints.length - 1; i++) {
                    totalDistance += map.distance(linePoints[i], linePoints[i + 1]);
                }
                
                // 更新测量结果
                document.getElementById('distance').textContent = totalDistance.toFixed(2);
                
                // 在最后一个点添加距离标签
                const lastPoint = linePoints[linePoints.length - 1];
                L.popup({
                    className: 'measure-popup',
                    closeButton: false
                })
                .setLatLng(lastPoint)
                .setContent(`<div style="color: #0f172a; font-size: 12px;">距离: ${totalDistance.toFixed(2)} 米</div>`)
                .openOn(map);
            }
        }
        
        // 4. 点聚合功能
        document.getElementById('showCluster').addEventListener('click', () => {
            // 清除已有的标记和聚合
            clearAllMarkers();
            
            // 显示加载提示
            showToast('正在生成点聚合...', 'info');
            
            // 创建点聚合组
            clusterGroup = L.markerClusterGroup({
                showCoverageOnHover: false,
                maxClusterRadius: 50,
                iconCreateFunction: function(cluster) {
                    return L.divIcon({
                        html: `<div style="background: rgba(56, 189, 248, 0.8); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; border: 2px solid rgba(255,255,255,0.5);">${cluster.getChildCount()}</div>`,
                        className: 'custom-cluster-icon',
                        iconSize: L.point(30, 30)
                    });
                }
            });
            
            // 确定中心点（优先使用用户位置）
            let center;
            if (lastKnownPosition) {
                center = {
                    lat: lastKnownPosition.coords.latitude,
                    lng: lastKnownPosition.coords.longitude
                };
            } else {
                center = map.getCenter();
            }
            
            // 创建以中心点为基础的边界
            const bounds = L.latLngBounds(
                [center.lat - 0.1, center.lng - 0.1],
                [center.lat + 0.1, center.lng + 0.1]
            );
            const southWest = bounds.getSouthWest();
            const northEast = bounds.getNorthEast();
            
            // 生成500个随机点
            for (let i = 0; i < 500; i++) {
                // 在范围内随机生成点
                const lat = southWest.lat + Math.random() * (northEast.lat - southWest.lat);
                const lng = southWest.lng + Math.random() * (northEast.lng - southWest.lng);
                
                const marker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        html: `<div style="background: #38bdf8; width: 10px; height: 10px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.7);"></div>`,
                        iconSize: [14, 14],
                        iconAnchor: [7, 7]
                    })
                });
                marker.bindPopup(`点 ${i + 1}<br>坐标: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
                
                clusterGroup.addLayer(marker);
                markers.push(marker);
            }
            
            // 添加到地图
            map.addLayer(clusterGroup);
            showToast('点聚合已显示', 'success');
        });
        
        // 5. 浏览器定位和视野跟随功能
        document.getElementById('locateMe').addEventListener('click', () => {
            // 检查浏览器是否支持地理定位
            if (!navigator.geolocation) {
                showToast("您的浏览器不支持地理定位功能", "error");
                return;
            }
            
            showLocationStatus("正在获取您的位置...", "info");
            
            // 单次获取位置
            navigator.geolocation.getCurrentPosition(
                handlePositionSuccess,
                handlePositionError,
                {
                    enableHighAccuracy: true,  // 高精度模式
                    timeout: 10000,             // 超时时间10秒
                    maximumAge: 0               // 不使用缓存位置
                }
            );
            
            // 如果之前没有监听位置，开始监听
            if (!watchId) {
                watchId = navigator.geolocation.watchPosition(
                    handlePositionSuccess,
                    handlePositionError,
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            }
            
            // 启用跟随按钮
            document.getElementById('followLocation').disabled = false;
        });
        
        document.getElementById('followLocation').addEventListener('click', () => {
            isFollowing = !isFollowing;
            const followBtn = document.getElementById('followLocation');
            
            if (isFollowing) {
                followBtn.classList.add('active');
                followBtn.innerHTML = '<i class="fas fa-stop-circle"></i> 停止跟随';
                showLocationStatus("已开启位置跟随", "success");
                
                // 如果已有位置信息，立即跟随
                if (lastKnownPosition) {
                    const coords = lastKnownPosition.coords;
                    map.setView([coords.latitude, coords.longitude], 16);
                }
            } else {
                followBtn.classList.remove('active');
                followBtn.innerHTML = '<i class="fas fa-compass"></i> 跟随位置';
                showLocationStatus("已停止位置跟随", "info");
            }
        });
        
        // 处理定位成功
        function handlePositionSuccess(position) {
            lastKnownPosition = position;
            const coords = position.coords;
            
            // 更新信息面板中的位置信息
            document.getElementById('userLocation').style.display = 'block';
            document.getElementById('locationCoord').textContent = 
                `${coords.latitude.toFixed(6)}, ${coords.longitude.toFixed(6)}`;
            
            showLocationStatus(`位置更新于 ${new Date().toLocaleTimeString()}`, "success");
            
            // 如果起点输入框为空，自动填充当前位置
            if (!document.getElementById('startPoint').value) {
                document.getElementById('startPoint').value = '我的位置';
            }
            
            // 创建或更新用户位置标记
            if (!userMarker) {
                // 创建自定义定位标记（带脉冲动画）
                userMarker = L.marker([coords.latitude, coords.longitude], {
                    icon: L.divIcon({
                        className: 'user-location-marker',
                        html: `
                            <div style="position: relative;">
                                <div class="pulse-animation" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 24px; height: 24px; background: rgba(56, 189, 248, 0.3); border-radius: 50%;"></div>
                                <div style="position: relative; width: 12px; height: 12px; background: #38bdf8; border: 2px solid rgba(255,255,255,0.8); border-radius: 50%;"></div>
                            </div>
                        `,
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    })
                }).addTo(map);
                
                userMarker.bindPopup(`<b style="color: #0f172a;">我的位置</b><br><span style="color: #0f172a;">精度: ${coords.accuracy.toFixed(1)} 米</span>`).openPopup();
                markers.push(userMarker);
                
                // 首次定位成功后移动到该位置
                map.setView([coords.latitude, coords.longitude], 16);
                showToast('已获取您的位置', 'success');
            } else {
                // 更新现有标记位置
                userMarker.setLatLng([coords.latitude, coords.longitude]);
                userMarker.getPopup().setContent(`<b style="color: #0f172a;">我的位置</b><br><span style="color: #0f172a;">精度: ${coords.accuracy.toFixed(1)} 米</span>`);
                
                // 如果开启了跟随模式，移动地图中心
                if (isFollowing) {
                    map.setView([coords.latitude, coords.longitude]);
                }
            }
        }
        
        // 处理定位错误
        function handlePositionError(error) {
            const errorMessages = {
                1: "用户拒绝了位置请求",
                2: "无法获取位置信息",
                3: "位置请求超时"
            };
            
            showLocationStatus(errorMessages[error.code] || "获取位置时发生错误", "error");
            showToast(errorMessages[error.code] || "获取位置时发生错误", "error");
        }
        
        // 显示定位状态信息
        function showLocationStatus(message, type) {
            const statusElement = document.getElementById('locationStatus');
            statusElement.textContent = message;
            
            // 设置状态样式
            statusElement.className = 'location-status';
            if (type === "error") {
                statusElement.style.color = "#f87171";
                statusElement.style.background = "rgba(248, 113, 113, 0.1)";
            } else if (type === "success") {
                statusElement.style.color = "#4ade80";
                statusElement.style.background = "rgba(74, 222, 128, 0.1)";
            } else {
                statusElement.style.color = "#38bdf8";
                statusElement.style.background = "rgba(56, 189, 248, 0.1)";
            }
        }
        
        // 6. POI搜索功能 - 使用真实高德地图API数据
        // 执行POI搜索
        function searchPOI(keyword) {
            if (!keyword.trim()) {
                showSearchResults([], "请输入搜索关键词");
                return;
            }
            
            // 显示加载状态
            showSearchResults([], "正在搜索...");
            
            // 确定搜索中心（优先使用用户位置）
            let center;
            if (lastKnownPosition) {
                center = {
                    lat: lastKnownPosition.coords.latitude,
                    lng: lastKnownPosition.coords.longitude
                };
            } else {
                center = map.getCenter();
            }
            
            // 调用高德地图POI搜索API
            const url = `https://restapi.amap.com/v3/place/text?key=${AMAP_API_KEY}&keywords=${encodeURIComponent(keyword)}&location=${center.lng},${center.lat}&radius=3000&offset=20&page=1&extensions=base`;
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('网络响应不正常');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === '1' && data.count > 0) {
                        // 处理API返回的POI数据
                        const poiData = data.pois.map(poi => {
                            // 解析位置信息
                            const [lng, lat] = poi.location.split(',').map(Number);
                            
                            // 提取主要类别
                            const category = poi.type.split(';')[0];
                            
                            return {
                                name: poi.name,
                                address: poi.address || '地址未知',
                                location: { lat, lng },
                                category: category,
                                tel: poi.tel || '无联系方式',
                                businessArea: poi.business_area || '未知商圈'
                            };
                        });
                        
                        showSearchResults(poiData);
                        addPOIMarkers(poiData);
                        showToast(`找到 ${poiData.length} 个相关地点`, 'success');
                    } else {
                        showSearchResults([], "未找到匹配的兴趣点");
                        showToast("未找到匹配的兴趣点", "info");
                    }
                })
                .catch(error => {
                    console.error('POI搜索出错:', error);
                    showSearchResults([], "搜索失败，请稍后重试");
                    showToast("搜索失败，请稍后重试", "error");
                });
        }
        
        // 显示搜索结果
        function showSearchResults(results, message = "") {
            const resultsContainer = document.getElementById('searchResults');
            
            if (results.length === 0 && message) {
                resultsContainer.innerHTML = `<div class="search-status">${message}</div>`;
                return;
            }
            
            let html = "";
            results.forEach((poi, index) => {
                html += `
                    <div class="search-result-item" data-index="${index}">
                        <div class="search-result-title">${poi.name}</div>
                        <div class="search-result-address">${poi.address}</div>
                        <div class="search-result-category">${poi.category}</div>
                    </div>
                `;
            });
            
            resultsContainer.innerHTML = html;
            
            // 为结果项添加点击事件
            document.querySelectorAll('.search-result-item').forEach(item => {
                item.addEventListener('click', () => {
                    const index = parseInt(item.getAttribute('data-index'));
                    const poi = results[index];
                    // 移动到该POI位置
                    map.setView([poi.location.lat, poi.location.lng], 16);
                    // 打开该POI的弹窗
                    if (poiMarkers[index]) {
                        poiMarkers[index].openPopup();
                    }
                    
                    // 如果终点输入框为空，自动填充当前选择的POI名称
                    if (!document.getElementById('endPoint').value) {
                        document.getElementById('endPoint').value = poi.name;
                    }
                });
            });
        }
        
        // 添加POI标记到地图
        function addPOIMarkers(poiData) {
            // 清除之前的POI标记
            clearPOIMarkers();
            
            // 为每个POI添加标记
            poiData.forEach(poi => {
                // 根据POI类别选择不同的图标
                let iconClass = "map-marker-alt"; // 默认图标
                const category = poi.category.toLowerCase();
                
                if (category.includes('餐厅') || category.includes('餐饮')) {
                    iconClass = "utensils";
                } else if (category.includes('酒店') || category.includes('住宿')) {
                    iconClass = "hotel";
                } else if (category.includes('超市') || category.includes('购物')) {
                    iconClass = "shopping-cart";
                } else if (category.includes('银行') || category.includes('金融')) {
                    iconClass = "credit-card";
                } else if (category.includes('医院') || category.includes('医疗')) {
                    iconClass = "hospital";
                } else if (category.includes('景点') || category.includes('公园') || category.includes('旅游')) {
                    iconClass = "camera";
                } else if (category.includes('学校') || category.includes('教育')) {
                    iconClass = "school";
                } else if (category.includes('地铁')) {
                    iconClass = "subway";
                } else if (category.includes('公交')) {
                    iconClass = "bus";
                } else if (category.includes('加油') || category.includes('加气')) {
                    iconClass = "gas-pump";
                }
                
                const marker = L.marker([poi.location.lat, poi.location.lng], {
                    icon: L.divIcon({
                        className: 'poi-marker',
                        html: `<i class="fas ${iconClass}" style="color: #38bdf8; font-size: 20px;"></i>`,
                        iconSize: [24, 24],
                        iconAnchor: [12, 24]
                    })
                }).addTo(map);
                
                marker.bindPopup(`
                    <strong style="color: #0f172a;">${poi.name}</strong><br>
                    类别: ${poi.category}<br>
                    地址: ${poi.address}<br>
                    商圈: ${poi.businessArea}<br>
                    电话: ${poi.tel}<br>
                    坐标: ${poi.location.lat.toFixed(6)}, ${poi.location.lng.toFixed(6)}
                `);
                
                poiMarkers.push(marker);
                markers.push(marker);
            });
            
            // 如果有多个结果，调整地图视野以显示所有POI
            if (poiData.length > 1) {
                const bounds = L.latLngBounds(
                    poiData.map(poi => [poi.location.lat, poi.location.lng])
                );
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }
        
        // 清除POI标记
        function clearPOIMarkers() {
            poiMarkers.forEach(marker => {
                if (marker && map.hasLayer(marker)) {
                    map.removeLayer(marker);
                    // 从总标记数组中移除
                    const index = markers.indexOf(marker);
                    if (index !== -1) {
                        markers.splice(index, 1);
                    }
                }
            });
            poiMarkers = [];
        }
        
        // 搜索按钮点击事件
        document.getElementById('poiSearchBtn').addEventListener('click', () => {
            const keyword = document.getElementById('poiSearchInput').value;
            searchPOI(keyword);
        });
        
        // 搜索框回车事件
        document.getElementById('poiSearchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const keyword = document.getElementById('poiSearchInput').value;
                searchPOI(keyword);
            }
        });
        
        // 7. 地图截图功能
        document.getElementById('takeScreenshot').addEventListener('click', () => {
            // 显示提示
            const screenshotBtn = document.getElementById('takeScreenshot');
            const originalText = screenshotBtn.innerHTML;
            screenshotBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在截图...';
            screenshotBtn.disabled = true;
            
            // 获取地图容器
            const mapContainer = document.getElementById('map');
            
            // 使用html2canvas进行截图
            html2canvas(mapContainer, {
                useCORS: true,
                logging: false,
                letterRendering: 1,
                allowTaint: false
            }).then(canvas => {
                // 创建下载链接
                const link = document.createElement('a');
                link.download = `map-screenshot-${new Date().getTime()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                // 恢复按钮状态
                screenshotBtn.innerHTML = originalText;
                screenshotBtn.disabled = false;
                
                // 显示成功提示
                showToast('地图截图已保存', 'success');
            }).catch(error => {
                console.error('截图失败:', error);
                screenshotBtn.innerHTML = originalText;
                screenshotBtn.disabled = false;
                showToast('截图失败，请重试', 'error');
            });
        });
        
        // 8. 路线规划功能 - 完善步行和公交路线
        document.getElementById('showRoutePanel').addEventListener('click', () => {
            const routePanel = document.getElementById('routePanel');
            routePanel.classList.toggle('active');
            
            if (routePanel.classList.contains('active')) {
                showToast('路线规划面板已打开', 'info');
            }
        });
        
        // 路线模式选择
        document.querySelectorAll('.route-mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.route-mode-btn').forEach(b => {
                    b.classList.remove('active');
                });
                btn.classList.add('active');
            });
        });
        
        // 计算路线
        document.getElementById('calculateRoute').addEventListener('click', () => {
            const startPoint = document.getElementById('startPoint').value;
            const endPoint = document.getElementById('endPoint').value;
            const routeMode = document.querySelector('.route-mode-btn.active').dataset.mode;
            
            if (!startPoint || !endPoint) {
                showToast('请输入起点和终点', 'warning');
                return;
            }
            
            // 清除已有路线
            clearRoute();
            
            showToast('正在规划路线...', 'info');
            
            // 获取起点坐标
            getLocationFromAddress(startPoint).then(startLoc => {
                // 获取终点坐标
                getLocationFromAddress(endPoint).then(endLoc => {
                    // 调用高德地图路线规划API
                    let url = '';
                    switch (routeMode) {
                        case 'driving':
                            url = `https://restapi.amap.com/v3/direction/driving?key=${AMAP_API_KEY}&origin=${startLoc.lng},${startLoc.lat}&destination=${endLoc.lng},${endLoc.lat}&extensions=all`;
                            break;
                        case 'walking':
                            url = `https://restapi.amap.com/v3/direction/walking?key=${AMAP_API_KEY}&origin=${startLoc.lng},${startLoc.lat}&destination=${endLoc.lng},${endLoc.lat}&extensions=all`;
                            break;
                        case 'transit':
                            // 获取起点所在城市
                            getCityCode(startLoc.lng, startLoc.lat).then(cityCode => {
                                url = `https://restapi.amap.com/v3/direction/transit/integrated?key=${AMAP_API_KEY}&origin=${startLoc.lng},${startLoc.lat}&destination=${endLoc.lng},${endLoc.lat}&city=${cityCode}&extensions=all`;
                                
                                fetchRouteData(url, routeMode, startLoc, endLoc);
                            }).catch(() => {
                                // 如果获取城市失败，使用默认城市（北京）
                                const cityCode = 110000; // 北京市
                                url = `https://restapi.amap.com/v3/direction/transit/integrated?key=${AMAP_API_KEY}&origin=${startLoc.lng},${startLoc.lat}&destination=${endLoc.lng},${endLoc.lat}&city=${cityCode}&extensions=all`;
                                fetchRouteData(url, routeMode, startLoc, endLoc);
                            });
                            return; // 退出当前函数，等待城市编码获取完成
                    }
                    
                    fetchRouteData(url, routeMode, startLoc, endLoc);
                }).catch(error => {
                    console.error('获取终点坐标失败:', error);
                    showToast('无法获取终点位置，请检查输入', 'error');
                });
            }).catch(error => {
                console.error('获取起点坐标失败:', error);
                showToast('无法获取起点位置，请检查输入', 'error');
            });
        });
        
        // 获取城市编码
        function getCityCode(lng, lat) {
            const url = `https://restapi.amap.com/v3/geocode/regeo?key=${AMAP_API_KEY}&location=${lng},${lat}&extensions=base`;
            
            return fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.status === '1' && data.addressComponent && data.addressComponent.citycode) {
                        return data.addressComponent.citycode;
                    } else {
                        throw new Error('获取城市编码失败');
                    }
                });
        }
        
        // 获取路线数据
        function fetchRouteData(url, routeMode, startLoc, endLoc) {
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.status === '1' && data.route && data.route.paths) {
                        currentRouteData = {
                            data: data,
                            startLoc: startLoc,
                            endLoc: endLoc
                        };
                        currentRouteMode = routeMode;
                        
                        displayRouteResults(data, routeMode, startLoc, endLoc);
                        showToast('路线规划完成', 'success');
                        document.getElementById('clearRoute').disabled = false;
                    } else {
                        showToast('无法规划路线，请尝试其他地点', 'error');
                    }
                })
                .catch(error => {
                    console.error('路线规划出错:', error);
                    showToast('路线规划失败，请重试', 'error');
                });
        }
        
        // 从地址获取坐标
        function getLocationFromAddress(address) {
            // 如果是"我的位置"且有定位信息，直接返回
            if (address === '我的位置' && lastKnownPosition) {
                return Promise.resolve({
                    lat: lastKnownPosition.coords.latitude,
                    lng: lastKnownPosition.coords.longitude
                });
            }
            
            // 调用高德地图地理编码API
            const url = `https://restapi.amap.com/v3/geocode/geo?key=${AMAP_API_KEY}&address=${encodeURIComponent(address)}`;
            
            return fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.status === '1' && data.geocodes && data.geocodes.length > 0) {
                        const location = data.geocodes[0].location.split(',');
                        return {
                            lng: parseFloat(location[0]),
                            lat: parseFloat(location[1])
                        };
                    } else {
                        throw new Error('地址解析失败');
                    }
                });
        }
        
        // 显示路线结果
        function displayRouteResults(data, routeMode, startLoc, endLoc) {
            const routeResults = document.getElementById('routeResults');
            const paths = data.route.paths;
            
            // 显示路线选项
            let html = '';
            paths.forEach((path, index) => {
                let distance = (path.distance / 1000).toFixed(1);
                let duration = Math.ceil(path.duration / 60);
                
                // 根据路线类型显示不同信息
                let routeInfo = '';
                if (routeMode === 'driving') {
                    routeInfo = `红绿灯: ${path.traffic_light || 0}个`;
                } else if (routeMode === 'walking') {
                    routeInfo = `步行导航`;
                } else if (routeMode === 'transit') {
                    routeInfo = `公交: ${path.transit_count || 0}次, 步行: ${(path.walking_distance / 1000).toFixed(1)}km`;
                }
                
                html += `
                    <div class="route-result-item" data-index="${index}">
                        <div class="route-result-title">路线 ${index + 1}</div>
                        <div class="route-result-details">
                            <span>距离: ${distance}km</span>
                            <span>时间: ${duration}分钟</span>
                        </div>
                        <div class="route-result-details" style="margin-top: 4px;">
                            <span>${routeInfo}</span>
                        </div>
                        <div class="route-result-details" style="margin-top: 4px;">
                            <span style="color: #38bdf8; font-size: 11px;">点击查看详情</span>
                        </div>
                    </div>
                `;
            });
            
            routeResults.innerHTML = html;
            
            // 添加路线选项点击事件
            document.querySelectorAll('.route-result-item').forEach(item => {
                item.addEventListener('click', () => {
                    const index = parseInt(item.getAttribute('data-index'));
                    drawRoute(paths[index], routeMode, startLoc, endLoc);
                    showRouteDetails(paths[index], routeMode);
                    
                    // 高亮选中的路线
                    document.querySelectorAll('.route-result-item').forEach(i => {
                        i.style.backgroundColor = 'rgba(30, 41, 59, 0.5)';
                    });
                    item.style.backgroundColor = 'rgba(59, 130, 246, 0.3)';
                });
            });
            
            // 默认显示第一条路线
            if (paths.length > 0) {
                drawRoute(paths[0], routeMode, startLoc, endLoc);
                showRouteDetails(paths[0], routeMode);
                document.querySelector('.route-result-item').style.backgroundColor = 'rgba(59, 130, 246, 0.3)';
            }
        }
        
        // 绘制路线
        function drawRoute(path, routeMode, startLoc, endLoc) {
            // 清除已有路线
            if (routeLayer) {
                map.removeLayer(routeLayer);
            }
            
            // 清除路线标记和公交站点标记
            routeMarkers.forEach(marker => {
                map.removeLayer(marker);
            });
            routeMarkers = [];
            
            busStopMarkers.forEach(marker => {
                map.removeLayer(marker);
            });
            busStopMarkers = [];
            
            // 根据路线类型绘制不同的路线
            let polylinePoints = [];
            
            if (routeMode === 'driving' || routeMode === 'walking') {
                // 驾车和步行路线
                path.steps.forEach(step => {
                    step.polyline.split(';').forEach(point => {
                        const [lng, lat] = point.split(',').map(Number);
                        polylinePoints.push([lat, lng]);
                    });
                });
            } else if (routeMode === 'transit') {
                // 公交路线 - 详细处理各段路线
                path.segments.forEach((segment, index) => {
                    if (segment.bus) {
                        // 公交段
                        segment.bus.polyline.split(';').forEach(point => {
                            const [lng, lat] = point.split(',').map(Number);
                            polylinePoints.push([lat, lng]);
                        });
                        
                        // 添加公交站点标记
                        if (segment.bus.stops && segment.bus.stops.length > 0) {
                            segment.bus.stops.forEach((stop, stopIndex) => {
                                const [lng, lat] = stop.location.split(',').map(Number);
                                
                                // 创建公交站点标记
                                const stopMarker = L.marker([lat, lng], {
                                    icon: L.divIcon({
                                        className: 'bus-stop-icon',
                                        html: `<div class="bus-stop-marker" style="width: 20px; height: 20px;">${stopIndex + 1}</div>`,
                                        iconSize: [20, 20],
                                        iconAnchor: [10, 10]
                                    })
                                }).addTo(map);
                                
                                stopMarker.bindPopup(`<b style="color: #0f172a;">${stop.name}</b><br><span style="color: #0f172a;">${segment.bus.buslines[0].name}</span>`);
                                busStopMarkers.push(stopMarker);
                            });
                        }
                    } else if (segment.walking) {
                        // 步行段
                        segment.walking.polyline.split(';').forEach(point => {
                            const [lng, lat] = point.split(',').map(Number);
                            polylinePoints.push([lat, lng]);
                        });
                    }
                });
            }
            
            // 设置路线颜色和样式
            let color, dashArray;
            if (routeMode === 'driving') {
                color = '#3b82f6'; // 驾车蓝色
                dashArray = '';
            } else if (routeMode === 'walking') {
                color = '#10b981'; // 步行绿色
                dashArray = '5, 5'; // 虚线表示步行
            } else if (routeMode === 'transit') {
                color = '#f59e0b'; // 公交橙色
                dashArray = '';
            }
            
            // 创建路线图层
            routeLayer = L.polyline(polylinePoints, {
                color: color,
                weight: 5,
                opacity: 0.8,
                lineJoin: 'round',
                dashArray: dashArray
            }).addTo(map);
            
            // 添加起点和终点标记
            const startMarker = L.marker([startLoc.lat, startLoc.lng], {
                icon: L.divIcon({
                    className: 'start-marker',
                    html: `<i class="fas fa-map-marker-alt" style="color: #10b981; font-size: 24px;"></i>`,
                    iconSize: [24, 24],
                    iconAnchor: [12, 24]
                })
            }).addTo(map);
            startMarker.bindPopup(`<b style="color: #0f172a;">起点</b>`);
            routeMarkers.push(startMarker);
            
            const endMarker = L.marker([endLoc.lat, endLoc.lng], {
                icon: L.divIcon({
                    className: 'end-marker',
                    html: `<i class="fas fa-flag" style="color: #ef4444; font-size: 24px;"></i>`,
                    iconSize: [24, 24],
                    iconAnchor: [12, 24]
                })
            }).addTo(map);
            endMarker.bindPopup(`<b style="color: #0f172a;">终点</b>`);
            routeMarkers.push(endMarker);
            
            // 调整地图视野以显示整个路线
            map.fitBounds(routeLayer.getBounds(), { padding: [50, 50] });
        }
        
        // 显示路线详情
        function showRouteDetails(path, routeMode) {
            const routeSummary = document.getElementById('routeSummary');
            const routeSteps = document.getElementById('routeSteps');
            const routeDetailsPanel = document.getElementById('routeDetailsPanel');
            
            // 显示路线摘要
            let distance = (path.distance / 1000).toFixed(1);
            let duration = Math.ceil(path.duration / 60);
            
            let summaryHtml = `
                <div class="route-summary-item">
                    <span class="route-summary-label">总距离:</span>
                    <span class="route-summary-value">${distance} 公里</span>
                </div>
                <div class="route-summary-item">
                    <span class="route-summary-label">预计时间:</span>
                    <span class="route-summary-value">${duration} 分钟</span>
                </div>
            `;
            
            // 根据路线类型添加额外信息
            if (routeMode === 'driving') {
                summaryHtml += `
                    <div class="route-summary-item">
                        <span class="route-summary-label">红绿灯:</span>
                        <span class="route-summary-value">${path.traffic_light || 0} 个</span>
                    </div>
                    <div class="route-summary-item">
                        <span class="route-summary-label">途经道路:</span>
                        <span class="route-summary-value">${path.roads ? path.roads.slice(0, 2).map(r => r.name).join('、') + (path.roads.length > 2 ? '...' : '') : '无'}</span>
                    </div>
                `;
            } else if (routeMode === 'transit') {
                summaryHtml += `
                    <div class="route-summary-item">
                        <span class="route-summary-label">公交次数:</span>
                        <span class="route-summary-value">${path.transit_count || 0} 次</span>
                    </div>
                    <div class="route-summary-item">
                        <span class="route-summary-label">步行距离:</span>
                        <span class="route-summary-value">${(path.walking_distance / 1000).toFixed(1)} 公里</span>
                    </div>
                `;
            }
            
            routeSummary.innerHTML = summaryHtml;
            
            // 显示路线步骤
            let stepsHtml = '';
            let stepNumber = 1;
            
            if (routeMode === 'driving' || routeMode === 'walking') {
                // 驾车和步行步骤
                path.steps.forEach(step => {
                    stepsHtml += `
                        <div class="route-step">
                            <div class="step-number">${stepNumber}</div>
                            <div class="step-details">
                                <div class="step-instruction">${step.instruction}</div>
                                <div class="step-distance">${(step.distance / 1000).toFixed(1)} 公里</div>
                            </div>
                        </div>
                    `;
                    stepNumber++;
                });
            } else if (routeMode === 'transit') {
                // 公交步骤
                path.segments.forEach(segment => {
                    if (segment.bus) {
                        // 公交段
                        const busLine = segment.bus.buslines[0];
                        stepsHtml += `
                            <div class="route-step">
                                <div class="step-number">${stepNumber}</div>
                                <div class="step-details">
                                    <div class="step-instruction">乘坐 ${busLine.name} (${busLine.start_stop} → ${busLine.end_stop})</div>
                                    <div class="step-distance">共 ${segment.bus.stops.length} 站，${(segment.distance / 1000).toFixed(1)} 公里</div>
                                </div>
                            </div>
                        `;
                        stepNumber++;
                        
                        // 上车点
                        stepsHtml += `
                            <div class="route-step">
                                <div class="step-number">${stepNumber}</div>
                                <div class="step-details">
                                    <div class="step-instruction">在 ${segment.bus.stops[0].name} 上车</div>
                                </div>
                            </div>
                        `;
                        stepNumber++;
                        
                        // 下车点
                        stepsHtml += `
                            <div class="route-step">
                                <div class="step-number">${stepNumber}</div>
                                <div class="step-details">
                                    <div class="step-instruction">在 ${segment.bus.stops[segment.bus.stops.length - 1].name} 下车</div>
                                </div>
                            </div>
                        `;
                        stepNumber++;
                    } else if (segment.walking) {
                        // 步行段
                        stepsHtml += `
                            <div class="route-step">
                                <div class="step-number">${stepNumber}</div>
                                <div class="step-details">
                                    <div class="step-instruction">${segment.walking.instruction || '步行'}</div>
                                    <div class="step-distance">${(segment.walking.distance / 1000).toFixed(1)} 公里</div>
                                </div>
                            </div>
                        `;
                        stepNumber++;
                    }
                });
            }
            
            routeSteps.innerHTML = stepsHtml;
            
            // 显示路线详情面板
            routeDetailsPanel.classList.add('active');
        }
        
        // 关闭路线详情面板
        document.getElementById('closeRouteDetails').addEventListener('click', () => {
            document.getElementById('routeDetailsPanel').classList.remove('active');
        });
        
        // 清除路线
        document.getElementById('clearRoute').addEventListener('click', () => {
            clearRoute();
            document.getElementById('clearRoute').disabled = true;
            document.getElementById('routeResults').innerHTML = '';
            document.getElementById('routeDetailsPanel').classList.remove('active');
            showToast('路线已清除', 'info');
        });
        
        function clearRoute() {
            if (routeLayer) {
                map.removeLayer(routeLayer);
                routeLayer = null;
            }
            
            routeMarkers.forEach(marker => {
                map.removeLayer(marker);
            });
            routeMarkers = [];
            
            // 清除公交站点标记
            busStopMarkers.forEach(marker => {
                map.removeLayer(marker);
            });
            busStopMarkers = [];
            
            currentRouteData = null;
            currentRouteMode = null;
        }
        
        // 9. 控制面板折叠功能
        document.getElementById('leftPanelToggle').addEventListener('click', () => {
            const panel = document.querySelector('.control-panel-left');
            const icon = document.querySelector('#leftPanelToggle i');
            
            panel.classList.toggle('collapsed');
            
            if (panel.classList.contains('collapsed')) {
                icon.classList.remove('fa-chevron-left');
                icon.classList.add('fa-chevron-right');
            } else {
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-left');
            }
        });
        
        document.getElementById('rightPanelToggle').addEventListener('click', () => {
            const panel = document.querySelector('.control-panel-right');
            const icon = document.querySelector('#rightPanelToggle i');
            
            panel.classList.toggle('collapsed');
            
            if (panel.classList.contains('collapsed')) {
                icon.classList.remove('fa-chevron-left');
                icon.classList.add('fa-chevron-right');
            } else {
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-left');
            }
        });
        
        // 基础控制功能
        document.getElementById('zoomIn').addEventListener('click', () => {
            map.zoomIn();
        });
        
        document.getElementById('zoomOut').addEventListener('click', () => {
            map.zoomOut();
        });
        
        document.getElementById('centerMap').addEventListener('click', () => {
            // 如果有用户位置，重置到用户位置，否则重置到北京
            if (lastKnownPosition) {
                const coords = lastKnownPosition.coords;
                map.setView([coords.latitude, coords.longitude], 16);
                showToast('已定位到您的位置', 'info');
            } else {
                map.setView([39.9042, 116.4074], 13);
                showToast('已重置地图中心', 'info');
            }
        });
        
        document.getElementById('addMarker').addEventListener('click', () => {
            // 确定标记位置（优先使用用户位置）
            let position;
            if (lastKnownPosition) {
                position = [
                    lastKnownPosition.coords.latitude,
                    lastKnownPosition.coords.longitude
                ];
            } else {
                position = map.getCenter();
            }
            
            const marker = L.marker(position, {
                icon: L.divIcon({
                    html: `<div style="background: #38bdf8; width: 10px; height: 10px; border-radius: 50%; border: 2px solid rgba(252, 165, 165, 0.7);"></div>`,
                    iconSize: [14, 14],
                    iconAnchor: [7, 7]
                }),
                draggable: true // 允许拖拽标记
            }).addTo(map);
            
            // 标记拖拽结束事件
            marker.on('dragend', function(event) {
                const position = event.target.getLatLng();
                marker.getPopup().setContent(`<b style="color: #0f172a;">标记</b><br><span style="color: #0f172a;">坐标: ${position.lat.toFixed(6)}, ${position.lng.toFixed(6)}</span>`);
            });
            
            // 为标记添加弹出窗口
            marker.bindPopup(`<b style="color: #0f172a;">新标记</b><br><span style="color: #0f172a;">坐标: ${position[0].toFixed(6)}, ${position[1].toFixed(6)}</span>`).openPopup();
            
            // 将标记添加到数组以便管理
            markers.push(marker);
            showToast('已添加新标记', 'info');
        });
        
        document.getElementById('clearMarkers').addEventListener('click', () => {
            clearAllMarkers();
            showToast('所有标记已清除', 'info');
        });
        
        // 清除所有标记（保留用户定位标记）
        function clearAllMarkers() {
            // 清除POI标记
            clearPOIMarkers();
            
            // 清除路线
            clearRoute();
            document.getElementById('clearRoute').disabled = true;
            document.getElementById('routeResults').innerHTML = '';
            document.getElementById('routeDetailsPanel').classList.remove('active');
            
            // 清除普通标记，但保留用户定位标记
            markers.forEach(marker => {
                if (marker !== userMarker) {
                    map.removeLayer(marker);
                }
            });
            
            // 过滤掉已移除的标记
            markers = userMarker ? [userMarker] : [];
            
            // 清除聚合标记
            if (clusterGroup) {
                map.removeLayer(clusterGroup);
                clusterGroup = null;
            }
            
            // 清除轨迹
            if (trackLayer) {
                map.removeLayer(trackLayer);
                trackLayer = null;
            }
            
            // 清除测量
            if (measureLine) {
                map.removeLayer(measureLine);
                measureLine = null;
            }
            measurePoints.forEach(point => {
                map.removeLayer(point);
            });
            measurePoints = [];
            document.getElementById('measureResult').style.display = 'none';
            
            // 如果正在测量，停止测量
            if (isMeasuring) {
                document.getElementById('stopMeasure').click();
            }
        }
        
        // 为地图添加点击事件，显示经纬度
        map.on('click', (e) => {
            // 如果正在测量，不显示这个弹窗
            if (!isMeasuring) {
                L.popup({
                    className: 'coord-popup'
                })
                .setLatLng(e.latlng)
                .setContent(`<div style="color: #0f172a; font-size: 12px;">点击位置: ${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}</div>`)
                .openOn(map);
            }
        });
        
        // 页面关闭时停止位置监听
        window.addEventListener('beforeunload', () => {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }
        });
        
        // 页面加载完成后显示欢迎提示
        window.addEventListener('load', () => {
            setTimeout(() => {
                showToast('欢迎使用智能地图系统，点击定位按钮获取您的位置', 'info');
            }, 1500);
        });
    </script>
</body>
</html>
